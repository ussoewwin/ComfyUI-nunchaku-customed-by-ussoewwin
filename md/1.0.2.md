# Z-Image-Turbo Nunchaku Loader Implementation: Complete Explanation

## Overview

7 files modified/created (3 new, 4 modified) to add Z-Image-Turbo (ZIT = Lumina2) support in ComfyUI via Nunchaku quantized models.

---

## Chapter 1: zimage.py (model base)

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_base/zimage.py` (NEW)

**Purpose:** ComfyUI model base that adapts Z-Image-Turbo to ComfyUI's KSampler loop. KSampler calls `MODEL.apply_model()` each step. Z-Image-Turbo's transformer (`NunchakuZImageTransformer2DModel`, a diffusers-style model) expects a different `forward()` signature and tensor shapes, so this file handles the compatibility layer.

### What it changes/implements

#### 1. Disable ComfyUI's automatic UNet creation

ComfyUI normally instantiates `unet_model(**unet_config, ...)`. This fails for Z-Image-Turbo because the Z-Image transformer constructor does not accept ComfyUI-specific config keys. Set `disable_unet_model_creation=True` and inject the pre-built transformer from the loader node.

#### 2. Override `_apply_model()` to match Z-Image forward requirements

Z-Image transformer expects:
- `x: List[Tensor]` where each element is `(C, F, H, W)`
- `cap_feats: List[Tensor]` (not `context=`)
- `return_dict=False` (to get tuple `(x,)`)

#### 3. Fix input shapes

- ComfyUI provides latents as `(B, C, H, W)`
- Z-Image expects list items shaped `(C, F, H, W)`
- Split batch â†’ list and add frame dimension `F=1`.

#### 4. Fix timestep mapping

In the working version:
- `t_normalized = self.model_sampling.timestep(t).float()`
- `t_zimage = 1.0 - t_normalized`

Pass `t_zimage` into the Z-Image transformer. This matches the "time inversion" behavior in the Z-Image pipeline (see Chapter 7).

#### 5. Fix output format and sign

Z-Image returns a list; stack it back to `(B, C, H, W)` (after squeezing `F=1`). Negate the output (`model_output = -model_output.float()`) because the Z-Image-Turbo pipeline negates `noise_pred`. Return `self.model_sampling.calculate_denoised(...)` using ComfyUI's FLOW contract.

### Key Code

```python
class NunchakuZImage(Lumina2):
    def __init__(...):
        unet_config = model_config.unet_config.copy()
        unet_config["disable_unet_model_creation"] = True
        ...
    def _apply_model(...):
        ...
        t_normalized = self.model_sampling.timestep(t).float()
        t_zimage = 1.0 - t_normalized
        ...
        model_output = self.diffusion_model(xc_list, t_zimage, cap_feats=cap_feats, **zimage_kwargs)
        ...
        model_output = -model_output.float()
        return self.model_sampling.calculate_denoised(sigma, model_output, x)
```

---

## Chapter 2: zimage.py (loader node)

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/nodes/models/zimage.py` (NEW)

**Purpose:** Adds the ComfyUI node that loads Nunchaku Z-Image-Turbo models and outputs a ComfyUI `MODEL`. This is the "loader node" equivalent of how Nunchaku's standalone script loads the transformer and uses the pipeline.

### What it implements

#### 1. `load_diffusion_model_state_dict(sd, metadata, model_options)`

Reconstructs a `NunchakuZImageTransformer2DModel` from safetensors metadata/config, following the same pattern as `NunchakuZImageTransformer2DModel.from_pretrained()`:

- Build from config (meta device)
- Patch/quantize (`_patch_model`)
- Move to load device with `to_empty`
- Patch scale keys (`patch_scale_key`)
- Load state dict (`load_state_dict`)

#### 2. Wrap into ComfyUI's model container

Creates a ComfyUI model (via `model_config.get_model(...)`) and replaces `model.diffusion_model = transformer` so ComfyUI uses the Nunchaku transformer.

#### 3. Expose a ComfyUI node: `NunchakuZImageDiTLoader`

Lets you select a `.safetensors` model and returns `(MODEL,)`.

### Key Code

```python
from nunchaku.models.transformers.transformer_zimage import NunchakuZImageTransformer2DModel
from ...model_configs.zimage import NunchakuZImage
from ...model_patcher import NunchakuModelPatcher
...
with torch.device("meta"):
    transformer = NunchakuZImageTransformer2DModel.from_config(config)
...
transformer._patch_model(...)
transformer = transformer.to_empty(device=load_device)
patch_scale_key(transformer, sd)
transformer.load_state_dict(sd)
...
model = model_config.get_model(dummy_sd, "", load_device)
model.diffusion_model = transformer
return NunchakuModelPatcher(model, ...)
```

---

## Chapter 3: zimage.py (model config)

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_configs/zimage.py` (NEW)

**Purpose:** Makes ComfyUI treat the model as a ZImage/Lumina2-family model configuration and ensures `get_model()` returns the correct `model_base.NunchakuZImage` (Chapter 1).

### What it does

- Inherits from `comfy.supported_models.ZImage`
- Overrides `get_model()` to instantiate `model_base.NunchakuZImage`

### Key Code

```python
from comfy.supported_models import ZImage

class NunchakuZImage(ZImage):
    def get_model(...):
        out = model_base.NunchakuZImage(self, device=device, **kwargs)
        return out
```

---

## Chapter 4: __init__.py

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/__init__.py` (MODIFIED)

**Purpose:** Register the new loader node so it appears in ComfyUI.

### What changed

Added import/registration of `NunchakuZImageDiTLoader` into `NODE_CLASS_MAPPINGS`.

### Key Code

```python
try:
    from .nodes.models.zimage import NunchakuZImageDiTLoader
    NODE_CLASS_MAPPINGS["NunchakuZImageDiTLoader"] = NunchakuZImageDiTLoader
except ImportError:
    logger.exception("Node `NunchakuZImageDiTLoader` import failed:")
```

---

## Chapter 5: model_base/__init__.py

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_base/__init__.py` (MODIFIED)

**Purpose:** Export the Z-Image base model so other modules can import it cleanly.

### What changed

Added `from .zimage import NunchakuZImage` and included it in `__all__`.

### Key Code

```python
from .qwenimage import NunchakuQwenImage
from .zimage import NunchakuZImage

__all__ = ["NunchakuQwenImage", "NunchakuZImage"]
```

---

## Chapter 6: model_patcher.py

**File:** `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_patcher.py` (MODIFIED)

**Purpose:** Fix a runtime incompatibility: ComfyUI's patcher may call `to_safely()`, but diffusers-style transformers (including `NunchakuZImageTransformer2DModel`) do not implement `to_safely`. Without this, loading/unloading can crash.

### What changed

In `load()` and `detach()`, check for `to_safely`; if missing, fall back to `.to(...)`.

### Key Code

```python
diffusion_model = self.model.diffusion_model
if hasattr(diffusion_model, 'to_safely'):
    diffusion_model.to_safely(device_to)
else:
    diffusion_model.to(device_to)
```

---

## Chapter 7: transformer_zimage.py

**File:** `python_embeded/Lib/site-packages/nunchaku/models/transformers/transformer_zimage.py` (MODIFIED / DEPENDENCY-CRITICAL)

**Purpose (for this integration):** This is the Nunchaku implementation of the Z-Image transformer. The loader node (Chapter 2) must follow the same correct loading/patching pipeline that Nunchaku expects.

### What matters here

`NunchakuZImageTransformer2DModel.from_pretrained()` shows the canonical sequence:

1. `_build_model(...)`
2. `_patch_model(...)`
3. `to_empty(device=...)`
4. `patch_scale_key(...)`
5. `load_state_dict(...)`

It also documents that offload is not supported.

### Key Code

```python
def from_pretrained(...):
    ...
    transformer, model_state_dict, metadata = cls._build_model(...)
    ...
    transformer._patch_model(...)
    transformer = transformer.to_empty(device=device)
    patch_scale_key(transformer, model_state_dict)
    transformer.load_state_dict(model_state_dict)
    return transformer
```

---

## Official References

Official references for how Z-Image-Turbo should be run:

- **Z-Image usage tutorial** (shows using `NunchakuZImageTransformer2DModel.from_pretrained` + `ZImagePipeline.from_pretrained`, and notes `guidance_scale=0.0`)
  - https://nunchaku.tech/docs/nunchaku/usage/zimage.html

- **Python API reference for `NunchakuZImageTransformer2DModel`**
  - https://nunchaku.tech/docs/nunchaku/python_api/nunchaku.models.transformers.transformer_zimage.html#nunchaku.models.transformers.transformer_zimage.NunchakuZImageTransformer2DModel

---

## Summary

### New Files (3)

1. `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_base/zimage.py`
   - ComfyUI model base adapter for Z-Image-Turbo

2. `ComfyUI/custom_nodes/ComfyUI-nunchaku/nodes/models/zimage.py`
   - Loader node for Nunchaku Z-Image-Turbo models

3. `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_configs/zimage.py`
   - Model configuration class for Z-Image

### Modified Files (4)

4. `ComfyUI/custom_nodes/ComfyUI-nunchaku/__init__.py`
   - Registered `NunchakuZImageDiTLoader` node

5. `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_base/__init__.py`
   - Exported `NunchakuZImage` class

6. `ComfyUI/custom_nodes/ComfyUI-nunchaku/model_patcher.py`
   - Added `to_safely()` fallback for diffusers-style transformers

7. `python_embeded/Lib/site-packages/nunchaku/models/transformers/transformer_zimage.py`
   - Reference implementation for loading/patching pipeline

**Total: 7 files** (3 new, 4 modified)

